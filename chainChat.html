<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
        <title>ChainChat</title>
        <!-- 引入 WeUI CDN 链接 -->
        <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.3.0/weui.min.css"/>
        <link rel="stylesheet" href="https://weui.io/style/weui.css">
        <!-- 引入聊天框架 -->
        
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="stylesheet" type="text/css" href="./litewebchat.min.css" />
    </head>
    <style>
      html,body{
        height: 100%;
        margin: 0;
        padding: 0;
      }
      </style>
    <body>
        <div class="weui-toptips weui-toptips_warn js_tooltips" style="opacity: 1; display: none;">错误提示</div>
        <div id="js_toast" style="display: none;">
          <div class="weui-mask_transparent"></div>
          <div class="weui-toast">
              <i class="weui-icon-success-no-circle weui-icon_toast"></i>
              <p class="weui-toast__content" id="successPrompt">已完成</p>
          </div>
        </div>

        <!-- Login panel begins-->
        <div id="loginPanel" class="page" style="display: block;">
            <div class="weui-form">
              <div class="weui-form__text-area">
                <h2 class="weui-form__title">登录</h2>
                <div id="loginPrompt" class="weui-form__desc">您可登录或创建本地账户，或导入账户。</div>
              </div>
              <div class="weui-form__control-area">
                <div class="weui-cells__group weui-cells__group_form">
                  <div class="weui-cells__title">若您填写的账号不存在，可导入账户或创建空白账户。</div>
                  <div class="weui-cells weui-cells_form">

                    <div class="weui-cell weui-cell_active" id="js_cell">
                      <div class="weui-cell__hd"><label class="weui-label">账号</label></div>
                      <div class="weui-cell__bd weui-flex">
                          <input id="js_input" class="weui-input" autofocus type="text" pattern="[0-9]*" placeholder="Account" maxlength="16" />
                          <button id="js_input_clear" class="weui-btn_reset weui-btn_icon weui-btn_input-clear">
                            <i class="weui-icon-clear"></i>
                          </button>
                      </div>
                    </div>

                    <div class="weui-cell weui-cell_active" id="js_cell_password">
                      <div class="weui-cell__hd"><label class="weui-label">密码</label></div>
                      <div class="weui-cell__bd weui-flex">
                          <input id="js_input_password" class="weui-input" autofocus type="text" placeholder="Password" maxlength="16" />
                          <button id="js_input_clear_password" class="weui-btn_reset weui-btn_icon weui-btn_input-clear">
                            <i class="weui-icon-clear"></i>
                          </button>
                      </div>
                    </div>

                  </div>
                </div>
                <div class="weui-cells__group weui-cells__group_form">
                  <div class="weui-cells__title">可用的MetaMask账户(这个版本需要用谷歌或火狐浏览器下载metamask钱包插件、创建以太坊账户、到Rinkeby测试网的水龙头免费获取以太币，通过添加对方账户开始聊天。ps：我的账户是0x0149F9346B3434CE3C0444a52937a715bcd7aF01，给我发信息吧！)</div>
                  <div class="weui-cells weui-cells_form">

                    <div class="weui-cell weui-cell_active weui-cell_readonly">
                      <div class="weui-cell__hd"><label class="weui-label">账户地址</label></div>
                      <div class="weui-cell__bd">
                          <input id="showAccount" class="weui-input" placeholder="请输入EMail" value="无" readonly/>
                      </div>
                    </div>

                    <div class="weui-cell weui-cell_active weui-cell_disabled">
                      <div class="weui-cell__hd"><label class="weui-label">昵称</label></div>
                      <div class="weui-cell__bd">
                          <input id="maskAccountName" class="weui-input" placeholder="请输入微信号" value="无" disabled/>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
              <div class="weui-form__opr-area">
                <a class="weui-btn weui-btn_primary weui-btn_disabled" href="javascript:" id="showTooltips">确定</a>
              </div>
              <div class="weui-form__opr-area">
                <a class="weui-btn weui-btn_primary weui-btn_disabled enableEthereumButton" href="javascript:" id="useMetaMask">使用MetaMask</a>
                <h2 style="opacity: 1; display: none;">Account: <span class="showAccount"></span></h2>
              </div>
            </div>

            <!-- The sheet for unexisted account-->
            <div>
              <div class="weui-mask" id="iosMask" style="display: none;"></div>
              <div class="weui-actionsheet" id="iosActionsheet">
                  <div class="weui-actionsheet__title">
                      <p class="weui-actionsheet__title-text">此账户不存在</p>
                  </div>
                  <div class="weui-actionsheet__menu">
                      <div class="weui-actionsheet__cell" id="clickNewAccount">创建账户</div>
                      <div class="weui-actionsheet__cell" id="clickExternalAccount">导入账户</div>
                      <div class="weui-actionsheet__cell weui-actionsheet__cell_warn">负向菜单</div>
                  </div>
                  <div class="weui-actionsheet__action">
                      <div class="weui-actionsheet__cell" id="iosActionsheetCancel">取消</div>
                  </div>
              </div>
            </div>
            <!-- /The sheet for unexisted account-->
            
            <!-- the sheet for new account-->
            <div class="js_dialog" id="newAccountSheet" style="display: none;">
              <div class="weui-mask"></div> 
              <div id="js_dialog_0" class="weui-half-screen-dialog">
                  <div class="weui-half-screen-dialog__hd">
                    <div class="weui-half-screen-dialog__hd__side">
                      <button style="display: none;" class="weui-icon-btn">返回<i class="weui-icon-back-arrow-thin"></i></button>
                      <button class="weui-icon-btn">关闭<i class="weui-icon-close-thin" onclick="cancelCreate()"></i></button>
                    </div>
                    <div class="weui-half-screen-dialog__hd__main">
                      <strong class="weui-half-screen-dialog__title">创建账号</strong>
                      <!--<span class="weui-half-screen-dialog__subtitle">标题</span> -->
                    </div>
                    <div class="weui-half-screen-dialog__hd__side">
                      <button class="weui-icon-btn">更多<i class="weui-icon-more"></i></button>
                    </div>
                  </div>
                  <div class="weui-half-screen-dialog__bd">
                    <p class="weui-half-screen-dialog__desc">
                      填写昵称
                    </p>
                    <div class="weui-cells weui-cells_form">
                      <div class="weui-cell ">
                          <div class="weui-cell__bd" >
                            <input id="newAccount" class="weui-input" autofocus type="text" placeholder="若有多个输入，请用分号隔开" />
                            
                            <div class="weui-textarea-counter"><span>0</span>/200</div>
                          </div>
                      </div>
                  </div>
                    
                  </div>
                  <div class="weui-half-screen-dialog__ft">
                      <a href="javascript:" class="weui-btn weui-btn_default" onclick="cancelCreate()">取消</a>
                      <a href="javascript:" class="weui-btn weui-btn_primary" onclick="createAccount()">确定</a>
                  </div>
              </div>
            </div>
            <!-- /the sheet for new account-->

            <!-- the sheet for extenal account-->
            <div class="js_dialog" id="loadAccountSheet" style="display: none;">
              <div class="weui-mask"></div> 
              <div id="js_dialog_1" class="weui-half-screen-dialog">
                  <div class="weui-half-screen-dialog__hd">
                    <div class="weui-half-screen-dialog__hd__side">
                      <button style="display: none;" class="weui-icon-btn">返回<i class="weui-icon-back-arrow-thin"></i></button>
                      <button class="weui-icon-btn">关闭<i class="weui-icon-close-thin" onclick="cancelLoad()"></i></button>
                    </div>
                    <div class="weui-half-screen-dialog__hd__main">
                      <strong class="weui-half-screen-dialog__title">导入账号</strong>
                      <!--<span class="weui-half-screen-dialog__subtitle">标题</span> -->
                    </div>
                    <div class="weui-half-screen-dialog__hd__side">
                      <button class="weui-icon-btn">更多<i class="weui-icon-more"></i></button>
                    </div>
                  </div>
                  <div class="weui-half-screen-dialog__bd">
                    <p class="weui-half-screen-dialog__desc">
                      
                    </p>
                    <div class="weui-cells weui-cells_form">
                      <div class="weui-cell ">
                          <div class="weui-cell__bd" >
                            <input id="externalAccount" class="weui-input" autofocus type="text" placeholder="若有多个输入，请用分号隔开" />
                            
                            <div class="weui-textarea-counter"><span>0</span>/200</div>
                          </div>
                      </div>
                  </div>
                    
                  </div>
                  <div class="weui-half-screen-dialog__ft">
                      <a href="javascript:" class="weui-btn weui-btn_default" onclick="cancelLoad()">取消</a>
                      <a href="javascript:" class="weui-btn weui-btn_primary" onclick="loadAccount()">确定</a>
                  </div>
              </div>
            </div>
            <!-- /the sheet for extenal account-->

            
          </div>
          <!-- Login panel ends-->



          <!-- Main panel begins-->
          <div id="mainPanel" class="page" style="display: none;">
            <div class="page__bd" style="height: 100%;">
                <div class="weui-tab">
                    <div class="weui-navbar">
                        <div class="weui-navbar__item weui-bar__item_on">
                            链信
                        </div>
                        <div class="weui-navbar__item">
                            通讯录
                        </div>
                        <div class="weui-navbar__item">
                            我
                        </div>
                    </div>
                    <div class="weui-tab__panel">
        
                    </div>
                </div>
            </div>

            <!-- My panel begins-->
            <div id="myPanel" style="display: none;">
              
              <div class="button-sp-area cell">
                <div class="weui-cell weui-cell_active weui-cell_readonly">
                  <div class="weui-cell__hd"><label class="weui-label">名片</label></div>
                  <div class="weui-cell__bd">
                      <input id="myInfo" class="weui-input" placeholder="自己" value="无" readonly/>
                  </div>
                  <a href="javascript:;" class="weui-btn weui-btn_primary" onclick="copyMyInfo()" >复制到剪贴板</a>
                </div>
                <a href="javascript:" class="weui-btn_cell weui-btn_cell-default" onclick="exportAccountSheet()" id="myInfo">导出账户</a>
                <a href="javascript:" class="weui-btn_cell weui-btn_cell-primary" id="requireToAll">向好友请求以太</a>
                <div class="weui-form__control-area">
                  <div class="weui-cells__group weui-cells__group_form">
                    <div class="weui-cells">
                      <div class="weui-cell weui-cell_active weui-cell_access weui-cell_select weui-cell_select-after">
                        <div class="weui-cell__hd"><label class="weui-label">      </label></div>
                        <div class="weui-cell__bd" id="">发送以太</div>
                      </div>
                    </div>
                  </div>
                </div>
                <a href="javascript:" id="sendETH" onclick="" class="weui-btn_cell weui-btn_cell-primary">
                  <img  class="weui-btn_cell__icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC4AAAAuCAMAAABgZ9sFAAAAVFBMVEXx8fHMzMzr6+vn5+fv7+/t7e3d3d2+vr7W1tbHx8eysrKdnZ3p6enk5OTR0dG7u7u3t7ejo6PY2Njh4eHf39/T09PExMSvr6+goKCqqqqnp6e4uLgcLY/OAAAAnklEQVRIx+3RSRLDIAxE0QYhAbGZPNu5/z0zrXHiqiz5W72FqhqtVuuXAl3iOV7iPV/iSsAqZa9BS7YOmMXnNNX4TWGxRMn3R6SxRNgy0bzXOW8EBO8SAClsPdB3psqlvG+Lw7ONXg/pTld52BjgSSkA3PV2OOemjIDcZQWgVvONw60q7sIpR38EnHPSMDQ4MjDjLPozhAkGrVbr/z0ANjAF4AcbXmYAAAAASUVORK5CYII=">
                  强调行按钮
                </a>
                <a href="javascript:" class="weui-btn_cell weui-btn_cell-warn" onclick="" id="clearAllMessage">清空聊天记录</a>
                <a href="javascript:" class="weui-btn_cell weui-btn_cell-warn" onclick="" id="deleteMyContact">删除</a>
              </div>

              <!-- the sheet for exporting account-->
            <div class="js_dialog" id="exportAccountSheet" style="display: none;">
              <div class="weui-mask"></div> 
              <div id="js_dialog_3" class="weui-half-screen-dialog">
                  <div class="weui-half-screen-dialog__hd">
                    <div class="weui-half-screen-dialog__hd__side">
                      <button style="display: none;" class="weui-icon-btn">返回<i class="weui-icon-back-arrow-thin"></i></button>
                      <button class="weui-icon-btn">关闭<i class="weui-icon-close-thin" onclick="cancelExport()"></i></button>
                    </div>
                    <div class="weui-half-screen-dialog__hd__main">
                      <strong class="weui-half-screen-dialog__title">导出账号</strong>
                      <!--<span class="weui-half-screen-dialog__subtitle">标题</span> -->
                    </div>
                    <div class="weui-half-screen-dialog__hd__side">
                      <button class="weui-icon-btn">更多<i class="weui-icon-more"></i></button>
                    </div>
                  </div>
                  <div class="weui-half-screen-dialog__bd">
                    
                    <div class="weui-cells weui-cells_form">
                      <div class="weui-cell ">
                          <div class="weui-cell__bd" >
                            
                            <input id="myAccount" class="weui-input" autofocus type="text" placeholder="自己" value="无" readonly/>
                            
                          </div>
                      </div>
                  </div>
                    
                  </div>
                  <div class="weui-half-screen-dialog__ft">
                      <a href="javascript:" class="weui-btn weui-btn_default" onclick="cancelExport()">取消</a>
                      <a href="javascript:" class="weui-btn weui-btn_primary" onclick="exportAccount()">复制</a>
                  </div>
              </div>
            </div>
            <!-- /the sheet for exporting account-->

            </div>
            <!-- My panel ends-->


            <!-- Contacts panel begins-->
            <div class="weui-panel weui-panel_access" id="contactPanel">
              <div class="weui-panel__hd">联系人</div>
              <div class="weui-cells" >
              <div class="weui-cell weui-cell_active weui-cell_access">
                  <div class="weui-cell__bd" onclick="returnMainPanel()">联系人</div>
                  <div class="weui-cell__ft" style="font-size: 0;">
                      <span style="vertical-align: middle; font-size: 17px;" onclick="clickAdd()">添加</span>
                      <span class="weui-icon-more" style="margin-left: 5px; margin-right: 5px;" onclick="clickAdd()"></span>
                  </div>
              </div>
              </div>

              <div id="contactList" class="weui-panel__bd">
                  <!-- Wait for contacts-->
              </div>

              <div class="weui-panel__ft">
                  <a href="javascript:" class="weui-cell weui-cell_active weui-cell_access weui-cell_link">
                      <div class="weui-cell__bd">查看更多</div>
                      <span class="weui-cell__ft"></span>
                  </a>    
              </div>
            </div>

            <!-- the sheet for new contacts or the ETH faucet account-->
            <div class="js_dialog" id="iosDialog2" style="display: none;">
              <div class="weui-mask"></div> 
              <div id="js_dialog_2" class="weui-half-screen-dialog">
                  <div class="weui-half-screen-dialog__hd">
                    <div class="weui-half-screen-dialog__hd__side">
                      <button style="display: none;" class="weui-icon-btn">返回<i class="weui-icon-back-arrow-thin"></i></button>
                      <button class="weui-icon-btn">关闭<i class="weui-icon-close-thin" onclick="cancelAdd()"></i></button>
                    </div>
                    <div class="weui-half-screen-dialog__hd__main">
                      <strong class="weui-half-screen-dialog__title">添加联系人或邀请码</strong>
                      <!--<span class="weui-half-screen-dialog__subtitle">标题</span> -->
                    </div>
                    <div class="weui-half-screen-dialog__hd__side">
                      <button class="weui-icon-btn">更多<i class="weui-icon-more"></i></button>
                    </div>
                  </div>
                  <div class="weui-half-screen-dialog__bd">
                    <p class="weui-half-screen-dialog__desc">
                      添加联系人账户公钥以通讯；添加邀请码（水龙头账户的公钥及私钥）以获取以太
                    </p>
                    <div class="weui-cells weui-cells_form">
                      <div class="weui-cell ">
                          <div class="weui-cell__bd" >
                            <input id="newContacts" class="weui-input" autofocus type="text" placeholder="若有多个输入，请用分号隔开" />
                            
                            <div class="weui-textarea-counter"><span>0</span>/200</div>
                          </div>
                      </div>
                  </div>
                    
                  </div>
                  <div class="weui-half-screen-dialog__ft">
                      <a href="javascript:" class="weui-btn weui-btn_default" onclick="cancelAdd()">取消</a>
                      <a href="javascript:" class="weui-btn weui-btn_primary" onclick="addContact()">确定</a>
                  </div>
              </div>
            </div>
            <!-- /the sheet for new contacts or the ETH faucet account-->

          </div>
          <!-- Main panel ends -->





          <!-- Chat Panel -->
          <div id="chatPanel" style="display: none;">

          <!-- fixed top navigating bar -->
          
              <div class="weui-cell weui-cell_active weui-cell_access"  style="  position: fixed;
              top: 0;
              left: 0;
              right: 0;
                z-index: 2;
                background-color:#ffffff;">
                  <div class="weui-cell__bd" onclick="returnMainPanel()">主界面/Main Panel</div>
                  <div class="weui-cell__ft" style="font-size: 0;">
                      <span style="vertical-align: middle; font-size: 17px;" onclick="accountPanel()">账户信息/Account Information</span>
                      <span class="weui-icon-more" style="margin-left: 5px; margin-right: 5px;" onclick="accountPanel()"></span>
                      <!--<span class="weui-badge weui-badge_dot" style="margin-left: 5px; margin-right: 5px;" onclick="accountPanel()"></span>-->
                  </div>
              </div>
           


            <!-- Message panel begins-->
            <div id="chatBox" class="lite-chatbox" style="  margin-top:70px; margin-bottom:80px;
            ">
              <!-- Wait for new messages-->

            </div>
            <!-- Message panel ends-->

            

            <!-- Fixed bottom message input and sending bar -->
            <div class="weui-search-bar" id="inputBar" style="  position: fixed;
            bottom: 0;
            width: 100%;
            ">
              <form class="weui-search-bar__form">
                  <div class="weui-search-bar__box">
                      
                      <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="" required/>
                      <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
                  </div>
                  <label class="weui-search-bar__label" id="searchText">
                      <i class=""></i>
                      <span>短信/Message</span>
                  </label>
              </form>
              <a href="javascript:;" class="weui-btn weui-btn_primary" onclick="" id="sendMessage">发送/Send</a>
            </div>
            <!-- /Fixed bottom message input and sending bar -->

          </div>
          <!-- Chat panel ends-->

          <!-- Account Panel -->
          <div id="accountPanel" style="display: none;" class="page button js_show container" style="background-color:#ededed;">
            <div class="weui-cell weui-cell_active weui-cell_access"  style="  
                background-color:#ffffff;">
                  <div class="weui-cell__bd" onclick="returnChatPanel()">返回</div>
              </div>
            <div class="page__hd">
              <h1 class="page__title" id="contactAddress"></h1>
              <p class="page__desc" id="contactName"></p>
            </div>
            <div class="button-sp-area cell">
              <a href="javascript:" class="weui-btn_cell weui-btn_cell-default" onclick="">复制公钥</a>
              <a href="javascript:" class="weui-btn_cell weui-btn_cell-primary" id="requireETH">向好友请求以太</a>
              <div class="weui-form__control-area">
                <div class="weui-cells__group weui-cells__group_form">
                  <div class="weui-cells">
                    <div class="weui-cell weui-cell_active weui-cell_access weui-cell_select weui-cell_select-after">
                      <div class="weui-cell__hd"><label class="weui-label">      </label></div>
                      <div class="weui-cell__bd" id="showPicker">发送以太</div>
                    </div>
                  </div>
                </div>
              </div>
              <a href="javascript:" id="sendETH" onclick="" class="weui-btn_cell weui-btn_cell-primary">
                <img  class="weui-btn_cell__icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC4AAAAuCAMAAABgZ9sFAAAAVFBMVEXx8fHMzMzr6+vn5+fv7+/t7e3d3d2+vr7W1tbHx8eysrKdnZ3p6enk5OTR0dG7u7u3t7ejo6PY2Njh4eHf39/T09PExMSvr6+goKCqqqqnp6e4uLgcLY/OAAAAnklEQVRIx+3RSRLDIAxE0QYhAbGZPNu5/z0zrXHiqiz5W72FqhqtVuuXAl3iOV7iPV/iSsAqZa9BS7YOmMXnNNX4TWGxRMn3R6SxRNgy0bzXOW8EBO8SAClsPdB3psqlvG+Lw7ONXg/pTld52BjgSSkA3PV2OOemjIDcZQWgVvONw60q7sIpR38EnHPSMDQ4MjDjLPozhAkGrVbr/z0ANjAF4AcbXmYAAAAASUVORK5CYII=">
                强调行按钮
              </a>
              <a href="javascript:" class="weui-btn_cell weui-btn_cell-warn" onclick="" id="clearMessage">清空聊天记录</a>
              <a href="javascript:" class="weui-btn_cell weui-btn_cell-warn" onclick="" id="deleteContact">删除</a>
            </div>
    
          </div>
          

          <div>

          </div>
          <script src="./jquery-3.1.1.min_1.js"></script>
          <script type="text/javascript" src="https://res.wx.qq.com/open/libs/weuijs/1.2.1/weui.min.js"></script>
          <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js" ></script>
          <script src="./clipboard.min.js"></script>
          <script type="text/javascript">
              var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
              const abi = [{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Give","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"time","type":"uint256"}],"name":"Read","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Require","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"Send","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"accounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"receiver","type":"address"}],"name":"giveETH","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"lenghth","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"messages","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"}],"name":"readMessage","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"requireETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"receiver","type":"address"},{"internalType":"string","name":"message","type":"string"}],"name":"sendMessage","outputs":[],"stateMutability":"nonpayable","type":"function"}];
              const add = '0xDbC0671B828485EB1d9b18bC17dE1ecCb528686A';
              var netContract = new web3.eth.Contract(abi);
              netContract.options.address = add;
                var accountAddress = "";
                var account;
                var accountName = "";
                var contacts = {
                                "0x69CE503E958A546Ee8841283C63badd41C5e11F0":{name : "contact-2", 
                                                                              messageCount : 0 , 
                                                                              messageSentCount : 0, 
                                                                              lastMessage: "", 
                                                                              messageList:[],
                                                                              messageUnread: 0} , 
                                "0x0879Def36D51f0ed87373A79F89857e99500702b":{name : "contact-3", 
                                                                              messageCount : 0 , 
                                                                              messageSentCount : 0, 
                                                                              lastMessage: "", 
                                                                              messageList:[],
                                                                              messageUnread: 0}};
                                                                              
                var messages = {};
                var gasEstimate = 0 ;
                var gasPrice = 0;
                var contactList = Object.keys(contacts);
                var totalLength = 0;//A symbol tells if unread messages are all acquired from the provider
                
                /***
                To rank the message received, construct an object to cache those messages. for every account, we have two memory,
                where t records the array of texts, each with an s for sender and an m for message; l records if the ranking process
                has started and the cache is locked; o records how many messages have been ranked. Each account has an f to record 
                if the first memory is used, while another is being written into the storage; c records the cooling time of account.
                **/
                var messageCache = {"0x0149F9346B3434CE3C0444a52937a715bcd7aF01":{"0":{t:[] , l:false , o:0 },
                                                                                  "1":{t:[] , l:false , o:0 },
                                                                                  c: "0" , t:0},
                                    "0x69CE503E958A546Ee8841283C63badd41C5e11F0":{"0":{t:[] , l:false , o:0 },
                                                                                  "1":{t:[] , l:false , o:0 },
                                                                                  c: "0" , t:0},
                                    "0x0879Def36D51f0ed87373A79F89857e99500702b":{"0":{t:[] , l:false , o:0 },
                                                                                  "1":{t:[] , l:false , o:0 },
                                                                                  c: "0" , t:0}
                                                                                                           }; //to order those message received

                var preLoad = 10;
              $(function(){
                
                var $tooltips = $('.js_tooltips');
                var $toast = $('#js_toast');
                var $input = $('#js_input');
                var $inputClear = $('#js_input_clear');
                var $cell = $('#js_cell');
          
                $input.on('input', function(){
                  var $value = $input.val();
                  if ($cell.hasClass('weui-cell_warn')){
                    $cell.removeClass('weui-cell_warn');
                  }
                  if ($value){
                    $('#showTooltips').removeClass('weui-btn_disabled');
                  }else{
                    $('#showTooltips').addClass('weui-btn_disabled');
                  }
                });
                $('#showTooltips').on('click', function(){
                    if ($(this).hasClass('weui-btn_disabled')) return;
          
                    var $value = $input.val();
                    if ($tooltips.css('display') != 'none') return;
          
                    // toptips的fixed, 如果有`animation`, `position: fixed`不生效
                    //$('.page.cell').removeClass('slideIn');
          
                    if($value.length < 3){
                      $cell.addClass('weui-cell_warn');
                      $tooltips.html('用户名少于三个字符');
                      $tooltips.fadeIn(100);
                      setTimeout(function () {
                        $tooltips.fadeOut(100);
                      }, 2000);
                    }else{
                      
                      if(localStorage.getItem($value))
                      {
                        console.log(localStorage.getItem($value));
                        accountName = $value;
                        let localAccount = JSON.parse(localStorage.getItem($value));//the string typed in is the key mapped to a decrypted account,
                        try{
                        account = web3.eth.accounts.decrypt(localAccount, $('#js_input_password').val());
                        }catch{
                          console.log("密码错误！");
                          $tooltips.html('密码错误！');
                          $tooltips.fadeIn(100);
                          setTimeout(function () {
                            $tooltips.fadeOut(100);
                          }, 2000);
                          return;
                        }
                        $('#successPrompt').html('登录成功');
                        $toast.fadeIn(100);
                        setTimeout(function () {               
                           $toast.fadeOut(100);
                         }, 2000);
                        accountAddress = account.address;  
                        console.log(accountAddress);
                        login();


                      }
                      else{
                        //to choose whether creat an account or load in one account
                        $('#iosActionsheet').addClass('weui-actionsheet_toggle');
                        console.log("Account is not exist!");
                        $('#iosMask').fadeIn(200);
                      }
                      //$('#loginPanel').fadeOut(100);
                      //mainPanel();
                    }
                });
                $inputClear.on('click', function(){
                  $('#js_input').empty();
                  console.log("Unsupport web storage!");
                  //$input.clear;
                });


                

              });

              //the sheet for unexist account
              var $iosActionsheet = $('#iosActionsheet');
                var $iosMask = $('#iosMask');

                function hideActionSheet() {
                 $iosActionsheet.removeClass('weui-actionsheet_toggle');
                 $iosMask.fadeOut(200);
                }

                $iosMask.on('click', hideActionSheet);
                $('#iosActionsheetCancel').on('click', hideActionSheet);
                $('#clickNewAccount').on('click' , newAccountSheet);
                $('#clickExternalAccount').on('click' , loadAccountSheet);

              const ethereumButton = document.querySelector('.enableEthereumButton');
                const showAccount = document.querySelector('.showAccount');

                //ethereumButton.addEventListener('click', () => {
                //  getAccount();
                //});

              async function getAccount() {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                const account = accounts[0];
                web3.setProvider(window.ethereum);
                //showAccount.innerHTML = account;
                accountAddress = web3.utils.toChecksumAddress(account);
                $('#showAccount').val(accountAddress);
                //console.log(accountAddress);
                if(localStorage.getItem(accountAddress) ){
                  contactList = JSON.parse(localStorage.getItem(accountAddress));
                  $('#maskAccountName').val(contactList[accountAddress].name);
                }
                }
          
            if (typeof(Storage) !== "undefined") {
              console.log("Start web storage.");
             // 针对 localStorage/sessionStorage 的代码
            } else {
            // 抱歉！不支持 Web Storage ..
            console.log("Unsupport web storage!");
            }
          
            //Unused code since metamask won't inject web3 any longer
            /**var web3Version = 0;
            if (typeof web3 !== 'undefined'){
              web3 = new Web3(web3.currenProviser)
              if (web3.version.api.charAt(0) !== '0')
                web3Version = 1;
              console.log("web3 version: "+ web3Version);
            } else {
              console.log("web3 undefined");
            }*/

            if (typeof window.ethereum !== 'undefined') {
               console.log('MetaMask is installed!');
               $('#loginPrompt').html("您可以登录账户，创建账户，导入账户信息，或连接MetaMask账户");
               //ethereum.request({ method: 'eth_requestAccounts' });
               $('#useMetaMask').removeClass('weui-btn_disabled');
               getAccount();
               //$('#loginPanel').fadeOut(100);
               //mainPanel();
            }
            else{
              web3.setProvider(new Web3.providers.WebsocketProvider("wss://rinkeby.infura.io/ws/v3/a898a2d231e647c7928dc457c6d441c8"));
              console.log("Use infura to connect to the net.");
            }

            ethereumButton.addEventListener('click', () => {
                  
                  //localStorage.setItem(accountAddress, "");
                  if(localStorage.getItem(accountAddress) ){
                    
                    login();
                  }
                  else{
                    //to choose whether creat an account or load in one account
                    $('#iosActionsheet').addClass('weui-actionsheet_toggle');
                    console.log("Account is not exist!");
                    $('#iosMask').fadeIn(200);
                  }
                  
                });

            function login(){
              $('#loginPanel').fadeOut(100);
              console.log(localStorage.getItem(accountAddress));
              contacts = $.extend(contacts , JSON.parse(localStorage.getItem(accountAddress)));
              contactList = Object.keys(contacts);
              $('#myInfo').val(contacts[accountAddress].name + ":" + accountAddress);
              mainPanel();

            }

            function copyMyInfo(){
              $('#myInfo').select();
                 
              if (document.execCommand('copy')) {
                  document.execCommand('copy');
                  $('#successPrompt').html('已复制');
                  $('#js_toast').fadeIn(100);
                  setTimeout(function () {               
                    $('#js_toast').fadeOut(100);
                  }, 2000);
                  console.log('复制成功');
              }
 
            }    
                

            function mainPanel(){
              $('#accountPanel').fadeOut(100);
              $('#mainPanel').fadeIn(100);
              estimateGas("sendETH:0");
              estimateGasPrice();
              for(let addr in contacts){
                 messageCache[addr]= {"0":{t:[] , l:false , o:0 },
                                      "1":{t:[] , l:false , o:0 },
                                      c: "0" , t:0};
              }
              console.log("mainPanel");
              showContactList();
              refreshContactList();
              //appendContacts();
              //chatPanel("0x0149f9346b3434ce3c0444a52937a715bcd7af01");
              
              //sendMessage(accountAddress,"test_sendMessage");

            }

            async function estimateGas(mess){
              gasEstimate = await netContract.methods.sendMessage(accountAddress , mess ).estimateGas({from:accountAddress});
              console.log("gasEstimate: " + gasEstimate );
            }

            async function estimateGasPrice(){
              gasPrice = await web3.eth.getGasPrice();
              console.log("gasEstimatePrice: " + gasPrice );
            }

            function returnMainPanel(){
              $('#contactList').empty();
              showContactList();
              //refreshContactList();
              $('#chatPanel').fadeOut(100);
              $('#mainPanel').fadeIn(100);
            }

            //Load the contact list and their last messages without connecting to the network
            function showContactList(){
              for(let i =0 ; i < contactList.length ; i ++){
                contactList = Object.keys(contacts);
                let addr = contactList[i] ;
                let unreadCount = contacts[addr].messageUnread ;
                let text ="";
                let mess = contacts[addr].lastMessage;
                let separatorPosition = mess.indexOf(":");
                let time = mess.slice(0 , separatorPosition);
                time = time.slice(8,10) + ":" + time.slice(10,12);
                mess = time + " " + mess.slice( separatorPosition+1);
                if(unreadCount == 0)
                {
                  text = '<a href="javascript:" onclick="chatPanel(\'' + addr+'\')" id="' + addr +'" class="weui-media-box weui-media-box_appmsg">'+
                      '<div class="weui-cell__hd" style="position: relative; margin-right: 10px;">'+
                        '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAAAeFBMVEUAwAD///+U5ZTc9twOww7G8MYwzDCH4YcfyR9x23Hw+/DY9dhm2WZG0kbT9NP0/PTL8sux7LFe115T1VM+zz7i+OIXxhes6qxr2mvA8MCe6J6M4oz6/frr+us5zjn2/fa67rqB4IF13XWn6ad83nxa1loqyirn+eccHxx4AAAC/klEQVRo3u2W2ZKiQBBF8wpCNSCyLwri7v//4bRIFVXoTBBB+DAReV5sG6lTXDITiGEYhmEYhmEYhmEYhmEY5v9i5fsZGRx9PyGDne8f6K9cfd+mKXe1yNG/0CcqYE86AkBMBh66f20deBc7wA/1WFiTwvSEpBMA2JJOBsSLxe/4QEEaJRrASP8EVF8Q74GbmevKg0saa0B8QbwBdjRyADYxIhqxAZ++IKYtciPXLQVG+imw+oo4Bu56rjEJ4GYsvPmKOAB+xlz7L5aevqUXuePWVhvWJ4eWiwUQ67mK51qPj4dFDMlRLBZTqF3SDvmr4BwtkECu5gHWPkmDfQh02WLxXuvbvC8ku8F57GsI5e0CmUwLz1kq3kD17R1In5816rGvQ5VMk5FEtIiWislTffuDpl/k/PzscdQsv8r9qWq4LRWX6tQYtTxvI3XyrwdyQxChXioOngH3dLgOFjk0all56XRi/wDFQrGQU3Os5t0wJu1GNtNKHdPqYaGYQuRDfbfDf26AGLYSyGS3ZAK4S8XuoAlxGSdYMKwqZKM9XJMtyqXi7HX/CiAZS6d8bSVUz5J36mEMFDTlAFQzxOT1dzLRljjB6+++ejFqka+mXIe6F59mw22OuOw1F4T6lg/9VjL1rLDoI9Xzl1MSYDNHnPQnt3D1EE7PrXjye/3pVpr1Z45hMUdcACc5NVQI0bOdS1WA0wuz73e7/5TNqBPhQXPEFGJNV2zNqWI7QKBd2Gn6AiBko02zuAOXeWIXjV0jNqdKegaE/kJQ6Bfs4aju04lMLkA2T5wBSYPKDGF3RKhFYEa6A1L1LG2yacmsaZ6YPOSAMKNsO+N5dNTfkc5Aqe26uxHpx7ZirvgCwJpWq/lmX1hA7LyabQ34tt5RiJKXSwQ+0KU0V5xg+hZrd4Bn1n4EID+WkQdgLfRNtvil9SPfwy+WQ7PFBWQz6dGWZBLkeJFXZGCfLUjCgGgqXo5TuSu3cugdcTv/HjqnBTEMwzAMwzAMwzAMwzAMw/zf/AFbXiOA6frlMAAAAABJRU5ErkJggg==" style="width: 50px; display: block;"/>'+
                        //'<span class="weui-badge" style="position: absolute; top: -0.4em; right: -0.4em;" >' + contacts[addr].messageUnread + '</span>' +
                      '</div>'+
                      '<div class="weui-media-box__bd">'+
                          '<h4 class="weui-media-box__title">'+ contacts[addr].name  +'</h4>'+
                          '<p class="weui-media-box__desc">'+ mess +'</p>'+
                      '</div>'+
                  '</a>';
                }
                else{
                  text = '<a href="javascript:" onclick="chatPanel(\'' + addr+'\')" id="' + addr +'" class="weui-media-box weui-media-box_appmsg">'+
                      '<div class="weui-cell__hd" style="position: relative; margin-right: 10px;">'+
                        '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAAAeFBMVEUAwAD///+U5ZTc9twOww7G8MYwzDCH4YcfyR9x23Hw+/DY9dhm2WZG0kbT9NP0/PTL8sux7LFe115T1VM+zz7i+OIXxhes6qxr2mvA8MCe6J6M4oz6/frr+us5zjn2/fa67rqB4IF13XWn6ad83nxa1loqyirn+eccHxx4AAAC/klEQVRo3u2W2ZKiQBBF8wpCNSCyLwri7v//4bRIFVXoTBBB+DAReV5sG6lTXDITiGEYhmEYhmEYhmEYhmEY5v9i5fsZGRx9PyGDne8f6K9cfd+mKXe1yNG/0CcqYE86AkBMBh66f20deBc7wA/1WFiTwvSEpBMA2JJOBsSLxe/4QEEaJRrASP8EVF8Q74GbmevKg0saa0B8QbwBdjRyADYxIhqxAZ++IKYtciPXLQVG+imw+oo4Bu56rjEJ4GYsvPmKOAB+xlz7L5aevqUXuePWVhvWJ4eWiwUQ67mK51qPj4dFDMlRLBZTqF3SDvmr4BwtkECu5gHWPkmDfQh02WLxXuvbvC8ku8F57GsI5e0CmUwLz1kq3kD17R1In5816rGvQ5VMk5FEtIiWislTffuDpl/k/PzscdQsv8r9qWq4LRWX6tQYtTxvI3XyrwdyQxChXioOngH3dLgOFjk0all56XRi/wDFQrGQU3Os5t0wJu1GNtNKHdPqYaGYQuRDfbfDf26AGLYSyGS3ZAK4S8XuoAlxGSdYMKwqZKM9XJMtyqXi7HX/CiAZS6d8bSVUz5J36mEMFDTlAFQzxOT1dzLRljjB6+++ejFqka+mXIe6F59mw22OuOw1F4T6lg/9VjL1rLDoI9Xzl1MSYDNHnPQnt3D1EE7PrXjye/3pVpr1Z45hMUdcACc5NVQI0bOdS1WA0wuz73e7/5TNqBPhQXPEFGJNV2zNqWI7QKBd2Gn6AiBko02zuAOXeWIXjV0jNqdKegaE/kJQ6Bfs4aju04lMLkA2T5wBSYPKDGF3RKhFYEa6A1L1LG2yacmsaZ6YPOSAMKNsO+N5dNTfkc5Aqe26uxHpx7ZirvgCwJpWq/lmX1hA7LyabQ34tt5RiJKXSwQ+0KU0V5xg+hZrd4Bn1n4EID+WkQdgLfRNtvil9SPfwy+WQ7PFBWQz6dGWZBLkeJFXZGCfLUjCgGgqXo5TuSu3cugdcTv/HjqnBTEMwzAMwzAMwzAMwzAMw/zf/AFbXiOA6frlMAAAAABJRU5ErkJggg==" style="width: 50px; display: block;"/>'+
                        '<span class="weui-badge" style="position: absolute; top: -0.4em; right: -0.4em;" >' + unreadCount + '</span>' +
                      '</div>'+
                      '<div class="weui-media-box__bd">'+
                          '<h4 class="weui-media-box__title">'+ contacts[addr].name  +'</h4>'+
                          '<p class="weui-media-box__desc">'+ mess  +'</p>'+
                      '</div>'+
                  '</a>';

                }
                

                $('#contactList').append(text);  

              }

            }

            /**This function would only be excuted when the main panel is opened for the first time. It is supposed to 
            register an sending event and an receiving event to listen to every events of contacts. In addition, for 
            every contacts, it will refresh messages, i.e., acquire new messages (from both sides) from the network; 
            And will initial the program to judge if the cache of a contact should be written into the storage.
            */
            function refreshContactList(){
              contactList = Object.keys(contacts);
              for(let i =0 ; i < contactList.length ; i ++){
                let addr = contactList[i] ;
                refreshContactMessage(addr);
                

              }
              registerEvent();
              openCacheListener(); 
            }

            async function registerEvent(){
              let blockNumber = await web3.eth.getBlockNumber();
              console.log("The block number when this page is loaded is: " + blockNumber);
              netContract.events.Send({filter: {to: [accountAddress]} , fromBlock : blockNumber} , receiveEvent);
              netContract.events.Send({filter: {from: [accountAddress]} , fromBlock : blockNumber} , sendEvent);
            }

            function receiveEvent(err , res){
              let addr = res.returnValues.from.trim();//.toLowerCase();
              if( res.returnValues.to.trim() != accountAddress)
                return;
              console.log("Message: " + res.returnValues.message  +" received! From: "+ res.returnValues.from );
              
              //console.log("start" + addr +"end");
              pushMessage(addr , res.returnValues.message , 0); 
              
            }

            function sendEvent(err , res){
              console.log("Message: " + res.returnValues.message +" sent! To: --"+ res.returnValues.to +"--" );
              if(  res.returnValues.from.trim() != accountAddress)
                return;
              let addr = res.returnValues.to.trim();//.toLowerCase();
              //console.log("start" + addr +"end");
              pushMessage(addr , res.returnValues.message , 3);
              
            }

            async function refreshContactMessage(addr){
              let length = await netContract.methods.lenghth(accountAddress, addr).call();
              
              
              //totalLength = await length;
              let message = "";
              let messageAcquired = contacts[addr].messageCount;
              if( length != messageAcquired & length >0){
                //contacts[addr].messageCount = length;
                for(let j = messageAcquired; j < length ; j ++){
                     refreshMessage(addr , j );
                     
                     //console.log(contacts[addr].messageList[j]);
                   }
                
                message = await netContract.methods.messages( accountAddress, addr , length -1 ).call();
                
                contacts[addr].lastMessage = message;
                let id = '#' + addr;
                contacts[addr].messageUnread = contacts[addr].messageUnread + length - messageAcquired;
                //console.log("mess1: "+ messageAcquired);
                let text = //'<a href="javascript:" onclick="chatPanel(\'' + addr+'\')" id="' + addr +'" class="weui-media-box weui-media-box_appmsg">'+
                      '<div class="weui-cell__hd" style="position: relative; margin-right: 10px;">'+
                        '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAAAeFBMVEUAwAD///+U5ZTc9twOww7G8MYwzDCH4YcfyR9x23Hw+/DY9dhm2WZG0kbT9NP0/PTL8sux7LFe115T1VM+zz7i+OIXxhes6qxr2mvA8MCe6J6M4oz6/frr+us5zjn2/fa67rqB4IF13XWn6ad83nxa1loqyirn+eccHxx4AAAC/klEQVRo3u2W2ZKiQBBF8wpCNSCyLwri7v//4bRIFVXoTBBB+DAReV5sG6lTXDITiGEYhmEYhmEYhmEYhmEY5v9i5fsZGRx9PyGDne8f6K9cfd+mKXe1yNG/0CcqYE86AkBMBh66f20deBc7wA/1WFiTwvSEpBMA2JJOBsSLxe/4QEEaJRrASP8EVF8Q74GbmevKg0saa0B8QbwBdjRyADYxIhqxAZ++IKYtciPXLQVG+imw+oo4Bu56rjEJ4GYsvPmKOAB+xlz7L5aevqUXuePWVhvWJ4eWiwUQ67mK51qPj4dFDMlRLBZTqF3SDvmr4BwtkECu5gHWPkmDfQh02WLxXuvbvC8ku8F57GsI5e0CmUwLz1kq3kD17R1In5816rGvQ5VMk5FEtIiWislTffuDpl/k/PzscdQsv8r9qWq4LRWX6tQYtTxvI3XyrwdyQxChXioOngH3dLgOFjk0all56XRi/wDFQrGQU3Os5t0wJu1GNtNKHdPqYaGYQuRDfbfDf26AGLYSyGS3ZAK4S8XuoAlxGSdYMKwqZKM9XJMtyqXi7HX/CiAZS6d8bSVUz5J36mEMFDTlAFQzxOT1dzLRljjB6+++ejFqka+mXIe6F59mw22OuOw1F4T6lg/9VjL1rLDoI9Xzl1MSYDNHnPQnt3D1EE7PrXjye/3pVpr1Z45hMUdcACc5NVQI0bOdS1WA0wuz73e7/5TNqBPhQXPEFGJNV2zNqWI7QKBd2Gn6AiBko02zuAOXeWIXjV0jNqdKegaE/kJQ6Bfs4aju04lMLkA2T5wBSYPKDGF3RKhFYEa6A1L1LG2yacmsaZ6YPOSAMKNsO+N5dNTfkc5Aqe26uxHpx7ZirvgCwJpWq/lmX1hA7LyabQ34tt5RiJKXSwQ+0KU0V5xg+hZrd4Bn1n4EID+WkQdgLfRNtvil9SPfwy+WQ7PFBWQz6dGWZBLkeJFXZGCfLUjCgGgqXo5TuSu3cugdcTv/HjqnBTEMwzAMwzAMwzAMwzAMw/zf/AFbXiOA6frlMAAAAABJRU5ErkJggg==" style="width: 50px; display: block;"/>'+
                        '<span class="weui-badge" style="position: absolute; top: -0.4em; right: -0.4em;" >' + contacts[addr].messageUnread + '</span>' +
                      '</div>'+
                      '<div class="weui-media-box__bd">'+
                          '<h4 class="weui-media-box__title">'+ contacts[addr].name  +'</h4>'+
                          '<p class="weui-media-box__desc">'+ message  +'</p>'+
                      '</div>';//+
                  //'</a>'; 
                $(id).html(text);
                //contacts[addr].messageCount = length;
                //contacts[addr].messageUnread = unreadCount;
              }

                length = await netContract.methods.lenghth(addr, accountAddress).call();
                if( length != contacts[addr].messageSentCount & length >0){

                  for(let i= contacts[addr].messageSentCount; i < length ; i ++){
                     refreshSelfMessage(addr , i );
                     //console.log(contacts[addr].messageList[j]);
                   }

                  let message1 = await netContract.methods.messages( addr, accountAddress , length -1 ).call();
                  if( strcpy(message , message1))
                  {
                  message = message1;
                  contacts[addr].lastMessage = message;
                  let id = '#' + addr;
                  //contacts[addr].messageUnread = contacts[addr].messageUnread + length - messageAcquired;
                  //console.log("mess1: "+ messageAcquired);
                  let text = //'<a href="javascript:" onclick="chatPanel(\'' + addr+'\')" id="' + addr +'" class="weui-media-box weui-media-box_appmsg">'+
                      '<div class="weui-cell__hd" style="position: relative; margin-right: 10px;">'+
                        '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAAAeFBMVEUAwAD///+U5ZTc9twOww7G8MYwzDCH4YcfyR9x23Hw+/DY9dhm2WZG0kbT9NP0/PTL8sux7LFe115T1VM+zz7i+OIXxhes6qxr2mvA8MCe6J6M4oz6/frr+us5zjn2/fa67rqB4IF13XWn6ad83nxa1loqyirn+eccHxx4AAAC/klEQVRo3u2W2ZKiQBBF8wpCNSCyLwri7v//4bRIFVXoTBBB+DAReV5sG6lTXDITiGEYhmEYhmEYhmEYhmEY5v9i5fsZGRx9PyGDne8f6K9cfd+mKXe1yNG/0CcqYE86AkBMBh66f20deBc7wA/1WFiTwvSEpBMA2JJOBsSLxe/4QEEaJRrASP8EVF8Q74GbmevKg0saa0B8QbwBdjRyADYxIhqxAZ++IKYtciPXLQVG+imw+oo4Bu56rjEJ4GYsvPmKOAB+xlz7L5aevqUXuePWVhvWJ4eWiwUQ67mK51qPj4dFDMlRLBZTqF3SDvmr4BwtkECu5gHWPkmDfQh02WLxXuvbvC8ku8F57GsI5e0CmUwLz1kq3kD17R1In5816rGvQ5VMk5FEtIiWislTffuDpl/k/PzscdQsv8r9qWq4LRWX6tQYtTxvI3XyrwdyQxChXioOngH3dLgOFjk0all56XRi/wDFQrGQU3Os5t0wJu1GNtNKHdPqYaGYQuRDfbfDf26AGLYSyGS3ZAK4S8XuoAlxGSdYMKwqZKM9XJMtyqXi7HX/CiAZS6d8bSVUz5J36mEMFDTlAFQzxOT1dzLRljjB6+++ejFqka+mXIe6F59mw22OuOw1F4T6lg/9VjL1rLDoI9Xzl1MSYDNHnPQnt3D1EE7PrXjye/3pVpr1Z45hMUdcACc5NVQI0bOdS1WA0wuz73e7/5TNqBPhQXPEFGJNV2zNqWI7QKBd2Gn6AiBko02zuAOXeWIXjV0jNqdKegaE/kJQ6Bfs4aju04lMLkA2T5wBSYPKDGF3RKhFYEa6A1L1LG2yacmsaZ6YPOSAMKNsO+N5dNTfkc5Aqe26uxHpx7ZirvgCwJpWq/lmX1hA7LyabQ34tt5RiJKXSwQ+0KU0V5xg+hZrd4Bn1n4EID+WkQdgLfRNtvil9SPfwy+WQ7PFBWQz6dGWZBLkeJFXZGCfLUjCgGgqXo5TuSu3cugdcTv/HjqnBTEMwzAMwzAMwzAMwzAMw/zf/AFbXiOA6frlMAAAAABJRU5ErkJggg==" style="width: 50px; display: block;"/>'+
                        '<span class="weui-badge" style="position: absolute; top: -0.4em; right: -0.4em;" >' + contacts[addr].messageUnread + '</span>' +
                      '</div>'+
                      '<div class="weui-media-box__bd">'+
                          '<h4 class="weui-media-box__title">'+ contacts[addr].name  +'</h4>'+
                          '<p class="weui-media-box__desc">'+ message  +'</p>'+
                      '</div>';//+
                  //'</a>'; 
                  $(id).html(text);
                  }

                }
                


            }

            async function refreshMessage( addr , index ){
              let mess = await netContract.methods.messages( accountAddress , addr , index).call();
              pushMessage(addr ,mess , 0);
              /**
              messageReceived.addr.push(mess);
              
              
              contacts[addr].messageCount ++ ;
              console.log("messageCount: " + contacts[addr].messageCount + " totalLength: "+ length);


              if (contacts[addr].messageCount == length){
              
                //The ordering part
                ///*
                console.log(messageReceived.addr);
                let messageOrder = [];
                for( let i = 0 ; i < messageReceived.addr.length ; i ++){
                  let mess = messageReceived.addr[i];
                  messageOrder.push(mess);
                  //console.log(messageOrder);
                  for(let j = 0 ; j < i ; j ++){
                    if (strcpy( mess , messageOrder[j])){
                     messageOrder.copyWithin(j+1 , j , messageOrder.length -1);
                     messageOrder[j] = mess;
                     break;
                    }
                  
                  }
                  console.log(messageOrder);
                }
                messageReceived.addr = [];
                 //console.log(messageOrder);
                 //The end of the ordering part
                 //

                 for( let i = 0 ; i < messageOrder.length ; i ++){
                  contacts[addr].messageList.push({s:0 , m: messageOrder[i]});
                 }
                 

                refreshMessagePanel();
                
              }*/

            }

            async function refreshSelfMessage( addr , index ){
              let mess = await netContract.methods.messages( addr , accountAddress , index).call();
              pushMessage(addr ,mess , 3);
            }



            function pushMessage(addr , mess, sender){
              //addr = addr.toLowerCase();
              console.log("push:" + addr);
              let cache = messageCache[addr].c;
              
              if( sender == 3){
                if (showSuccess(addr , mess))
                return;
              }
              else{
                //if( repetition (addr ,mess))
                //return;
              }
              if( sender == 0){
                contacts[addr].messageCount ++;
              }
              console.log(sender);
              
              messageCache[addr].t = 0;
                messageCache[addr][cache].t.push({s:sender , m: mess});
                if(!messageCache[addr][cache].l){
                  messageCache[addr][cache].l = true;
                  rankMessage(addr , cache);
                  messageCache[addr][cache].l = false;
                }
              
            }

            function rankMessage(addr , cache){
              
              let originLength = messageCache[addr][cache].t.length;

              for( let i = messageCache[addr][cache].o ; i < originLength ; i ++){
                  let mess = messageCache[addr][cache].t[i];
                  //messageOrder.push(mess);
                  //console.log(messageOrder);
                  for(let j = 0 ; j < i ; j ++){
                    if (strcpy( mess.m ,  messageCache[addr][cache].t[j].m)){
                      messageCache[addr][cache].t.copyWithin(j+1 , j , i);
                      messageCache[addr][cache].t[j] = mess;
                     break;
                    }
                  
                  }
                  
                }
                contacts[addr].lastMessage = messageCache[addr][cache].t[originLength -1].m;
                messageCache[addr][cache].o = originLength;
                refreshMessagePanel();
                console.log("Finish ranking! Result: " );
                console.log( messageCache[addr][cache]);

            }

            function strcpy(str1,str2){
              let date1 = Number(str1.split(":")[0]);
              let date2 = Number(str2.split(":")[0]);
              if(date1 > date2)
                return false;
              else if(date1 = date2)
              {
                return true;

              }
              else
                return true;
            }

            function showSuccess(addr , mess){
              /**
              if (addr == accountAddress){
                console.log("is myself");
                return false;
              }*/
              console.log(addr);
              console.log(accountAddress);
              for(let i = contacts[addr].messageList.length-1 ; i >= 0 ; i--){
                if( mess ==contacts[addr].messageList[i].m){
                  contacts[addr].messageList[i].s = 1;
                  refreshMessagePanel();
                  return true;
                }
              }
              
              for (let i = 0 ; i < messageCache[addr]["0"].t.length ; i++){
                if( mess == messageCache[addr]["0"].t[i].m){
                  messageCache[addr]["0"].t[i].s = 3;
                  refreshMessagePanel();
                  return true;
                }

              }

              for (let i = 0 ; i < messageCache[addr]["1"].t.length ; i++){
                if( mess == messageCache[addr]["0"].t[i].m){
                  messageCache[addr]["0"].t[i].s = 3;
                  refreshMessagePanel();
                  return true;
                }

              }
              return false;
            }

            function repetition(addr , mess){
              console.log(addr);
              console.log(accountAddress);
              for(let i = contacts[addr].messageList.length-1 ; i >= 0 ; i--){
                if( mess ==contacts[addr].messageList[i].m){
                  //contacts[addr].messageList[i].s = 1;
                  //refreshMessagePanel();
                  return true;
                }
              }
              
              for (let i = 0 ; i < messageCache[addr]["0"].t.length ; i++){
                if( mess == messageCache[addr]["0"].t[i].m){
                  //messageCache[addr]["0"].t[i].s = 3;
                  //refreshMessagePanel();
                  return true;
                }

              }

              for (let i = 0 ; i < messageCache[addr]["1"].t.length ; i++){
                if( mess == messageCache[addr]["0"].t[i].m){
                 // messageCache[addr]["0"].t[i].s = 3;
                  //refreshMessagePanel();
                  return true;
                }

              }
              return false;
            }

            function openCacheListener(){
              setInterval(coolCache , 5000);
            }

            function coolCache(){
              contactList = Object.keys(contacts);
              for( j in contactList)
              {
                let addr = contactList[j];
                //console.log(addr);
                if(messageCache[addr]["0"].t.length + messageCache[addr]["1"].t.length > 0)
                  messageCache[addr].t ++;
                if( messageCache[addr].t >6){
                  messageCache[addr].t = 0;
                  let cache = messageCache[addr].c;
                  if(cache == "0"){
                    messageCache[addr].c = "1";
                  }
                  else{
                    messageCache[addr].c = "0";

                  }
                  //messageCache[addr].c = ! cache;
                  for (let i = 0 ; i<  messageCache[addr][cache].t.length ; i ++){
                    storeMessage(addr ,   messageCache[addr][cache].t[i] );
                    
                  }
                  messageCache[addr][cache].t = [];
                  messageCache[addr][cache].o = 0;
                  refreshMessagePanel();
                }
              }
              

            }

            function storeMessage(addr , text){
              if( text.s == 2){
                text.s = 4;
              }
              else if (text.s == 3){
                text.s =1;
                contacts[addr].messageSentCount++;
              }
              else if(text.s == 0){
                contacts[addr].messageCount++;
              }
              contacts[addr].messageList.push(text);
              refreshStorage();
            }

            function refreshStorage(){
              localStorage.setItem(accountAddress, JSON.stringify(contacts));
              //$('#contactPanel').empty();
              $('#contactList').empty();
              showContactList();
         
            }

            function clickAdd(){
              $('#iosDialog2').fadeIn(200);
              $('#js_dialog_2').addClass('weui-half-screen-dialog_show');

            }

            function addContact(){
              let newContacts = $('#newContacts').val().split(";");
              for (let i in newContacts)
              {
                console.log( newContacts[i]);
                let addr = newContacts[i].split(":")[1];
                let nickname = newContacts[i].split(":")[0];
                contacts[addr] = {name : nickname, 
                                messageCount : 0 , 
                                messageSentCount : 0, 
                                lastMessage: "", 
                                messageList:[],
                                messageUnread: 0};
                 contactList = Object.keys(contacts);
                 messageCache[addr]= {"0":{t:[] , l:false , o:0 },
                                      "1":{t:[] , l:false , o:0 },
                                      c: "0" , t:0};
              }
              
              refreshStorage();
              $('#js_toast').fadeIn(100);
                      setTimeout(function () {
                        $('#js_toast').fadeOut(100);
                      }, 2000);
              $('#iosDialog2').fadeOut(200);
              $('#js_dialog_2').removeClass('weui-half-screen-dialog_show');

            }

            function cancelAdd(){
              $('#iosDialog2').fadeOut(200);
              $('#js_dialog_2').removeClass('weui-half-screen-dialog_show');
            }

            //new account sheet
            function newAccountSheet(){
              hideActionSheet();
              $('#newAccountSheet').fadeIn(200);
              $('#js_dialog_0').addClass('weui-half-screen-dialog_show');
            }

            function createAccount(){
              let newAccount = $('#newAccount').val();
              if( ($('#js_input').val()!= "") & ($('#js_input_password').val()!="")){
                console.log('No metamask account:' + $('#js_input').val() );
                let entropy = $('#js_input').val() + $('#js_input_password').val();
                for (let i = entropy.length ; i < 32 ; i++){
                  entropy = entropy +"0";
                }
                account =  web3.eth.accounts.create([entropy]);
                console.log("New address has been generated!" + account);
                accountAddress = account.address;
                localStorage.setItem($('#js_input').val(), JSON.stringify(web3.eth.accounts.encrypt(account.privateKey, $('#js_input_password').val())));

                let newContacts = {};
                newContacts[accountAddress]={name : newAccount, 
                                           messageCount : 0 ,
                                           messageSentCount : 0, 
                                           lastMessage: "", 
                                          messageList:[],
                                           messageUnread: 0};
                localStorage.setItem(accountAddress,  JSON.stringify(newContacts)  );
                messageCache[accountAddress]={"0":{t:[] , l:false , o:0 },
                                                                                  "1":{t:[] , l:false , o:0 },
                                                                                  c: "0" , t:0};
               //contactList = Object.keys(contacts);
               $('#newAccountSheet').fadeOut(200);
               $('#js_dialog_0').removeClass('weui-half-screen-dialog_show');
               login();    

              }
              else{
                let newContacts = {};
                newContacts[accountAddress]={name : newAccount, 
                                           messageCount : 0 ,
                                           messageSentCount : 0, 
                                           lastMessage: "", 
                                          messageList:[],
                                           messageUnread: 0};
                localStorage.setItem(accountAddress, JSON.stringify(newContacts));
                messageCache[accountAddress]={"0":{t:[] , l:false , o:0 },
                                                                                  "1":{t:[] , l:false , o:0 },
                                                                                  c: "0" , t:0};
               //contactList = Object.keys(contacts);
               $('#newAccountSheet').fadeOut(200);
               $('#js_dialog_0').removeClass('weui-half-screen-dialog_show');
               login();                                                                   
              }

            }

            function cancelCreate(){
              $('#newAccountSheet').fadeOut(200);
              $('#js_dialog_0').removeClass('weui-half-screen-dialog_show');
            }

            //export account sheet
            function exportAccountSheet(){
              $('#exportAccountSheet').fadeIn(200);
              let accountInfo = {};
              accountInfo[accountName] = JSON.parse(localStorage.getItem(accountName));
              accountInfo[accountAddress] = contacts;
              //accountName +"\":\"" + localStorage.getItem(accountName) + "\";\"" + accountAddress + "\":\"" + localStorage.getItem(accountAddress);
              console.log(accountInfo);
              $('#myAccount').val(JSON.stringify(accountInfo));
              $('#js_dialog_3').addClass('weui-half-screen-dialog_show');
            }

            function exportAccount(){
              $('#myAccount').select();
                 
              if (document.execCommand('copy')) {
                  document.execCommand('copy');
                  $('#successPrompt').html('已复制');
                  $('#js_toast').fadeIn(100);
                  setTimeout(function () {               
                    $('#js_toast').fadeOut(100);
                  }, 2000);
                  console.log('复制成功');
              }

            }

            function cancelExport(){
              $('#exportAccountSheet').fadeOut(200);
              $('#js_dialog_3').removeClass('weui-half-screen-dialog_show');
            }

            //extenal account sheet
            function loadAccountSheet(){
              hideActionSheet();
              $('#loadAccountSheet').fadeIn(200);
              $('#js_dialog_1').addClass('weui-half-screen-dialog_show');
              
            }

            function loadAccount(){
              let input = $('#externalAccount').val();
              let accountInfo = JSON.parse( $('#externalAccount').val());
              let names = Object.keys(accountInfo);
              localStorage.setItem(names[0] , JSON.stringify(accountInfo[names[0]]));
              localStorage.setItem(names[1] , JSON.stringify(accountInfo[names[1]]));
              $('#successPrompt').html('导入成功');
                  $('#js_toast').fadeIn(100);
                  setTimeout(function () {               
                    $('#js_toast').fadeOut(100);
                  }, 2000);
              $('#loadAccountSheet').fadeOut(200);
              $('#js_dialog_1').removeClass('weui-half-screen-dialog_show');
              

            }

            function cancelload(){
              $('#loadAccountSheet').fadeOut(200);
              $('#js_dialog_1').removeClass('weui-half-screen-dialog_show');
            }

            function acquireAccount(){

            }

            //deprecated since its low speed
            async function acquireMessage(){
              var contactList = Object.keys(contacts);
              console.log(contactList.length);
              for( let i = 0 ; i < contactList.length ; i++)
              {
                 let addr = contactList[i] ;
                 //let len = 0;
                 //let mess = "";
                 let length = await netContract.methods.lenghth(accountAddress, addr).call();
                 console.log(i + length);
                 let message = "";
                 let text = '';
                 if( length != contacts[addr].messageCount){
                   if (length > 0)
                     message = await netContract.methods.messages( accountAddress, addr , length -1 ).call();
                   console.log(message);
                   contacts[addr].lastMessage = message ;

                   text = '<a href="javascript:" onclick="chatPanel(\'' + addr+'\')" class="weui-media-box weui-media-box_appmsg">'+
                      
                      '<div class="weui-cell__hd" style="position: relative; margin-right: 10px;">'+
                        '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAAAeFBMVEUAwAD///+U5ZTc9twOww7G8MYwzDCH4YcfyR9x23Hw+/DY9dhm2WZG0kbT9NP0/PTL8sux7LFe115T1VM+zz7i+OIXxhes6qxr2mvA8MCe6J6M4oz6/frr+us5zjn2/fa67rqB4IF13XWn6ad83nxa1loqyirn+eccHxx4AAAC/klEQVRo3u2W2ZKiQBBF8wpCNSCyLwri7v//4bRIFVXoTBBB+DAReV5sG6lTXDITiGEYhmEYhmEYhmEYhmEY5v9i5fsZGRx9PyGDne8f6K9cfd+mKXe1yNG/0CcqYE86AkBMBh66f20deBc7wA/1WFiTwvSEpBMA2JJOBsSLxe/4QEEaJRrASP8EVF8Q74GbmevKg0saa0B8QbwBdjRyADYxIhqxAZ++IKYtciPXLQVG+imw+oo4Bu56rjEJ4GYsvPmKOAB+xlz7L5aevqUXuePWVhvWJ4eWiwUQ67mK51qPj4dFDMlRLBZTqF3SDvmr4BwtkECu5gHWPkmDfQh02WLxXuvbvC8ku8F57GsI5e0CmUwLz1kq3kD17R1In5816rGvQ5VMk5FEtIiWislTffuDpl/k/PzscdQsv8r9qWq4LRWX6tQYtTxvI3XyrwdyQxChXioOngH3dLgOFjk0all56XRi/wDFQrGQU3Os5t0wJu1GNtNKHdPqYaGYQuRDfbfDf26AGLYSyGS3ZAK4S8XuoAlxGSdYMKwqZKM9XJMtyqXi7HX/CiAZS6d8bSVUz5J36mEMFDTlAFQzxOT1dzLRljjB6+++ejFqka+mXIe6F59mw22OuOw1F4T6lg/9VjL1rLDoI9Xzl1MSYDNHnPQnt3D1EE7PrXjye/3pVpr1Z45hMUdcACc5NVQI0bOdS1WA0wuz73e7/5TNqBPhQXPEFGJNV2zNqWI7QKBd2Gn6AiBko02zuAOXeWIXjV0jNqdKegaE/kJQ6Bfs4aju04lMLkA2T5wBSYPKDGF3RKhFYEa6A1L1LG2yacmsaZ6YPOSAMKNsO+N5dNTfkc5Aqe26uxHpx7ZirvgCwJpWq/lmX1hA7LyabQ34tt5RiJKXSwQ+0KU0V5xg+hZrd4Bn1n4EID+WkQdgLfRNtvil9SPfwy+WQ7PFBWQz6dGWZBLkeJFXZGCfLUjCgGgqXo5TuSu3cugdcTv/HjqnBTEMwzAMwzAMwzAMwzAMw/zf/AFbXiOA6frlMAAAAABJRU5ErkJggg==" style="width: 50px; display: block;"/>'+
                        '<span class="weui-badge" style="position: absolute; top: -0.4em; right: -0.4em;" >' + (length - contacts[addr].messageCount) + '</span>'+
                      '</div>'+
                      '<div class="weui-media-box__bd">'+
                          '<h4 class="weui-media-box__title">'+ contacts[addr].name  +'</h4>'+
                          '<p class="weui-media-box__desc">'+ contacts[addr].lastMessage  +'</p>'+
                      '</div>'+
                  '</a>';
                 }

                 else{
                  text = '<a href="javascript:" onclick="chatPanel(\'' + addr+'\')" class="weui-media-box weui-media-box_appmsg">'+
                      '<div class="weui-cell__hd" style="position: relative; margin-right: 10px;">'+
                        '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAAAeFBMVEUAwAD///+U5ZTc9twOww7G8MYwzDCH4YcfyR9x23Hw+/DY9dhm2WZG0kbT9NP0/PTL8sux7LFe115T1VM+zz7i+OIXxhes6qxr2mvA8MCe6J6M4oz6/frr+us5zjn2/fa67rqB4IF13XWn6ad83nxa1loqyirn+eccHxx4AAAC/klEQVRo3u2W2ZKiQBBF8wpCNSCyLwri7v//4bRIFVXoTBBB+DAReV5sG6lTXDITiGEYhmEYhmEYhmEYhmEY5v9i5fsZGRx9PyGDne8f6K9cfd+mKXe1yNG/0CcqYE86AkBMBh66f20deBc7wA/1WFiTwvSEpBMA2JJOBsSLxe/4QEEaJRrASP8EVF8Q74GbmevKg0saa0B8QbwBdjRyADYxIhqxAZ++IKYtciPXLQVG+imw+oo4Bu56rjEJ4GYsvPmKOAB+xlz7L5aevqUXuePWVhvWJ4eWiwUQ67mK51qPj4dFDMlRLBZTqF3SDvmr4BwtkECu5gHWPkmDfQh02WLxXuvbvC8ku8F57GsI5e0CmUwLz1kq3kD17R1In5816rGvQ5VMk5FEtIiWislTffuDpl/k/PzscdQsv8r9qWq4LRWX6tQYtTxvI3XyrwdyQxChXioOngH3dLgOFjk0all56XRi/wDFQrGQU3Os5t0wJu1GNtNKHdPqYaGYQuRDfbfDf26AGLYSyGS3ZAK4S8XuoAlxGSdYMKwqZKM9XJMtyqXi7HX/CiAZS6d8bSVUz5J36mEMFDTlAFQzxOT1dzLRljjB6+++ejFqka+mXIe6F59mw22OuOw1F4T6lg/9VjL1rLDoI9Xzl1MSYDNHnPQnt3D1EE7PrXjye/3pVpr1Z45hMUdcACc5NVQI0bOdS1WA0wuz73e7/5TNqBPhQXPEFGJNV2zNqWI7QKBd2Gn6AiBko02zuAOXeWIXjV0jNqdKegaE/kJQ6Bfs4aju04lMLkA2T5wBSYPKDGF3RKhFYEa6A1L1LG2yacmsaZ6YPOSAMKNsO+N5dNTfkc5Aqe26uxHpx7ZirvgCwJpWq/lmX1hA7LyabQ34tt5RiJKXSwQ+0KU0V5xg+hZrd4Bn1n4EID+WkQdgLfRNtvil9SPfwy+WQ7PFBWQz6dGWZBLkeJFXZGCfLUjCgGgqXo5TuSu3cugdcTv/HjqnBTEMwzAMwzAMwzAMwzAMw/zf/AFbXiOA6frlMAAAAABJRU5ErkJggg==" style="width: 50px; display: block;"/>'+
                        //'<span class="weui-badge" style="position: absolute; top: -0.4em; right: -0.4em;" >' +  + '</span>'
                      '</div>'+
                      '<div class="weui-media-box__bd">'+
                          '<h4 class="weui-media-box__title">'+ contacts[addr].name  +'</h4>'+
                          '<p class="weui-media-box__desc">'+ contacts[addr].lastMessage  +'</p>'+
                      '</div>'+
                  '</a>';

                 }

                
                 $('#contactList').append(text);
                 

                 if( length != contacts[addr].messageCount){
                   for(let j = contacts[addr].messageCount; j < length ; j ++){
                     let mess = await netContract.methods.messages( accountAddress , addr , j).call();
                     contacts[addr].messageList.push({s:0 , m: mess});
                     //console.log(contacts[addr].messageList[j]);
                   }
                   contacts[addr].messageCount = length;
                 }
                 console.log(contacts);

        
               }

            }

            function chatPanel(addr){
              $('#mainPanel').fadeOut(100);
              $('#chatPanel').fadeIn(100);
              $('#chatBox').empty();
              $('#sendMessage').attr( "onclick", " sendMessage(\'" + addr + "\')" );
              //let originLength = contacts[addr].messageList.length;
              refreshMessagePanel();
              contacts[addr].messageUnread =0;
              refreshStorage();
            }

            function returnChatPanel(){
              $('#accountPanel').fadeOut(100);
              $('#chatPanel').fadeIn(100);
            }

            function showMessage(addr , i){
              let separatorPosition = contacts[addr].messageList[i].m.indexOf(":");
              let time = contacts[addr].messageList[i].m.slice(0 , separatorPosition);
              time = time.slice(0,4) + "-" + time.slice(4,6) + "-" + time.slice(6,8) + " " + time.slice(8,10) + ":" + time.slice(10,12);
              let mess = contacts[addr].messageList[i].m.slice( separatorPosition+1);
              let sender = contacts[addr].messageList[i].s;
              let text1 = '<div class="tips">'+
                         '<span>' + time + '</span>'+
                          '</div>';

                if( sender== 0)
                {
                  text = '<!-- cleft 左 -->'+
                         '<div class="cleft cmsg">'+
                           '<img class="headIcon radius" ondragstart="return false;"  oncontextmenu="return false;" src="./img/A.jpg" />'+
                           '<span class="name">'+ contacts[addr].name  +'</span>'+
                           '<span class="content">'+  mess +'</span>'+                        
                         '</div>';

                }
                else if(sender == 1){
                  text = '<!-- cright 右 -->'+
                         '<div class="cright cmsg">'+
                           '<img class="headIcon radius" ondragstart="return false;"  oncontextmenu="return false;" src="./img/A.jpg" />'+
                           '<span class="name">'+ contacts[accountAddress].name  +'</span>'+
                           '<span class="content">'+  mess +'</span>'+                        
                         '</div>';

                }

                else{
                  text = '<!-- cright 右 -->'+
                         '<div class="cright cmsg">'+
                           '<img class="headIcon radius" ondragstart="return false;"  oncontextmenu="return false;" src="./img/A.jpg" />'+
                           '<span class="name">'+ contacts[accountAddress].name  +'</span>'+
                           '<span class="content">'+  mess +'</span>'+                        
                         '</div>';

                }
                
                $('#chatBox').append(text1);
                $('#chatBox').append(text);  

                if(sender == 2){
                  text1 = '<div class="tips">' + 
                          '<span class="tips-primary">网络消息：等待发送</span>'+
                          '</div>' ;
                  $('#chatBox').append(text1);
                }
                else if( sender == 3 ){
                  text1 = '<div class="tips">' + 
                          '<span class="tips-success">网络消息：发送成功</span>'+
                          '</div>' ;
                  $('#chatBox').append(text1);
                }
                else if(sender == 4 ){
                  text1 = '<div class="tips">' + 
                          '<span class="tips-danger">网络消息：发送失败</span>'+
                          '</div>' ;
                  $('#chatBox').append(text1);
                } 
            }

            function showCacheMessage(addr , i , cache){
              let mess = messageCache[addr][cache].t[i].m;
              let sender = messageCache[addr][cache].t[i].s;
              let separatorPosition = mess.indexOf(":");
              let time = mess.slice(0 , separatorPosition);
              time = time.slice(0,4) + "-" + time.slice(4,6) + "-" + time.slice(6,8) + " " + time.slice(8,10) + ":" + time.slice(10,12);
              mess = mess.slice( separatorPosition+1);
              let text1 = '<div class="tips">'+
                         '<span>' + time + '</span>'+
                          '</div>';

                if(sender == 0)
                {
                  text = '<!-- cleft 左 -->'+
                         '<div class="cleft cmsg">'+
                           '<img class="headIcon radius" ondragstart="return false;"  oncontextmenu="return false;" src="./img/A.jpg" />'+
                           '<span class="name">'+ contacts[addr].name  +'</span>'+
                           '<span class="content">'+  mess +'</span>'+                        
                         '</div>';

                }
                else{
                  text = '<!-- cright 右 -->'+
                         '<div class="cright cmsg">'+
                           '<img class="headIcon radius" ondragstart="return false;"  oncontextmenu="return false;" src="./img/A.jpg" />'+
                           '<span class="name">'+ contacts[accountAddress].name  +'</span>'+
                           '<span class="content">'+  mess +'</span>'+                        
                         '</div>';

                }
                
                $('#chatBox').append(text1);
                $('#chatBox').append(text);  

                if(sender == 2){
                  text1 = '<div class="tips">' + 
                          '<span class="tips-primary">网络消息：等待发送</span>'+
                          '</div>' ;
                  $('#chatBox').append(text1);
                }
                else if( sender == 3 ){
                  text1 = '<div class="tips">' + 
                          '<span class="tips-success">网络消息：发送成功</span>'+
                          '</div>' ;
                  $('#chatBox').append(text1);
                }
                else if(sender == 4 ){
                  text1 = '<div class="tips">' + 
                          '<span class="tips-danger">网络消息：发送失败</span>'+
                          '</div>' ;
                  $('#chatBox').append(text1);
                }
            }

            /**Refresh the message panel currently showed
            */
            function refreshMessagePanel(){

              console.log("refresh message");
              if($('#sendMessage').attr("onclick") == ""){
                return;
              }
              $('#chatBox').empty();
              let addr = $('#sendMessage').attr("onclick").replace("sendMessage('","");
              addr = addr.replace("')" , "");
              addr = addr.replace(" " , "");
              //console.log("start" + addr +"end");
              let originLength = contacts[addr].messageList.length;
              for(let i = 0 ; i <  originLength ; i++)
              {
                       showMessage(addr , i); 
              }
              let cache = messageCache[addr].c;
              for(let i = 0 ; i <  messageCache[addr][cache].t.length ; i++)
              {
                       showCacheMessage(addr , i , cache); 
              }
            }

            async function sendMessage(receiver){
              console.log("sendMessage");
              let mess = getTime() +  $('#searchInput').val();
              console.log(mess);
              pushMessage(receiver , mess , 2);
              
              if(accountName != ""){
                gasEstimate = await netContract.methods.sendMessage(accountAddress , mess ).estimateGas({from:accountAddress});
                netContract.methods.sendMessage(receiver,mess).send({from:accountAddress}).on('sending', signTx);
              }
              else{
                let receipt = await netContract.methods.sendMessage(receiver,mess).send({from:accountAddress});
                console.log(receipt);
              }
              
              

            }

            function signTx(payload){
              let tx = payload.params[0];
              tx.gas = gasEstimate;
              tx['chain'] = 'rinkeby';
              tx['hardfork'] = 'constantinople';
              web3.eth.accounts.signTransaction(tx, account.privateKey).then(sendTx);

            }

            function sendTx(signedTx){
              let signedTransactionData = signedTx.rawTransaction;

              web3.eth.sendSignedTransaction(signedTransactionData );
            }

            function accountPanel(){
              let addr = $('#sendMessage').attr("onclick").replace("sendMessage('","");
              addr = addr.replace("')" , "");
              addr = addr.replace(" " , "");
              console.log("Account Panel of: " + "--" + addr +"--");
              $('#chatPanel').fadeOut(100);
              $('#accountPanel').fadeIn(100);
              document.getElementById("contactAddress").innerHTML=addr ;
              document.getElementById("contactName").innerHTML=contacts[addr].name ;
              //$('#contactAddress').val(addr);
              //$('#contactName').val(contacts[addr].name);
              $('#requireETH').attr( "onclick", " requireETH(\'" + addr + "\')" );

              $('#showPicker').on('click', function () {
                  weui.picker([{
                  label: '每条短信消耗以太*10（适用于救急）',
                  value:  gasEstimate * gasPrice *10
                  }, {
                  label: '每条短信消耗以太*1000（适用于工作关系）',
                  value: gasEstimate * gasPrice *1000
                  }, {
                  label: '每条短信消耗以太*10000（适用于朋友）',
                  value: gasEstimate * gasPrice *10000
                  },{
                  label: '1以太 (适用于情侣)',
                  
                  value: 1000000000000000000
                  }, {
                  label: '其他',
                  disabled: true,
                  value: 4
                  }], {
                  onChange: function (result) {
                    console.log(result);
                  },
                  onConfirm: function (result) {
                    console.log(result);
                    sendETH(addr , result[0].value);
                  },
                  title: '单列选择器'
                  });
              });
              $('#sendETH').attr( "onclick", " sendETH(\'" + addr + "\')" );
              $('#clearMessage').attr( "onclick", " clearMessage(\'" + addr + "\')" );
            }

            async function clearMessage(addr){
              let reciept = await netContract.methods.readMessage(addr).send({from:accountAddress});
              console.log(reciept);
            }

            async function requireETH(receiver){
              console.log("requireETH");
              let mess = getTime() +  "ETH";
              console.log(mess);
              pushMessage(receiver , mess , 2);
              let receipt = await netContract.methods.sendMessage(receiver,mess).send({from:accountAddress});
              
              console.log(receipt);

            }

            async function sendETH(receiver , amount){
              console.log("sendETH");
              //let amount = gasEstimate * gasPrice *10;
              let mess = getTime() +  "sendETH: " +amount ;
              console.log(mess);
              pushMessage(receiver , mess , 2);
              let receipt = await netContract.methods.giveETH(receiver).send({from:accountAddress , value: amount});
              
              console.log(receipt);

            }

            function getTime(){
              let date = new Date();  //创建对象  
              let y = date.getFullYear();     //获取年份  
              let m =date.getMonth()+1;   //获取月份  返回0-11  
              let d = date.getDate(); // 获取日  
              let w = date.getDay();   //获取星期几  返回0-6   (0=星期天) 
              let ww = ' 星期'+'日一二三四五六'.charAt(new Date().getDay()) ;//星期几
              let h = date.getHours();  //时
              let minute = date.getMinutes()  //分
              let s = date.getSeconds(); //秒
              let sss = date.getMilliseconds() ; //毫秒
              if(m<10){
                m = "0"+m;
                }
              if(d<10){
                d = "0"+d;
                }
             if(h<10){
h = "0"+h;
}
 
 
if(minute<10){
minute = "0"+minute;
}
 
 
if(s<10){
s = "0"+s;
}
 
 
if(sss<10){
sss = "00"+sss;
}else if(sss<100){
sss = "0"+sss;
}
 
 
return y+ "" +m+ ""  +d+ ""  +h+ ""  +minute+ "" +s+":";
            }



          </script>
          
          <script type="text/javascript">
            $(function(){
                $('.weui-navbar__item').on('click', function () {
                    $(this).addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
                    console.log($(this).text().trim());
                    if($(this).text().trim() == "链信"){
                      $('#myPanel').fadeOut(100);
                      console.log($(this).text().trim());
                      $('#contactPanel').fadeIn(100);
                    }
                    if($(this).text().trim() == "我"){
                      $('#contactPanel').fadeOut(100);
                      console.log($(this).text().trim());
                      $('#myPanel').fadeIn(100);
                    }
                });
            });
         </script>
         <script>
           async function appendContacts(){
             await acquireMessage();
             let text = '<a href="javascript:" class="weui-media-box weui-media-box_appmsg">'+
                      '<div class="weui-media-box__hd">'+
                          '<img class="weui-media-box__thumb" src="" alt="">'+
                      '</div>'+
                      '<div class="weui-media-box__bd">'+
                          '<h4 class="weui-media-box__title">标题一</h4>'+
                          '<p class="weui-media-box__desc">由各种物质组成的巨型球状天体，叫做星球。星球有一定的形状，有自己的运行轨道。</p>'+
                      '</div>'+
                  '</a>';
             $('#contactList').append(text);

           }

         </script>

         <script type="text/javascript">
    $(function(){
        var $searchBar = $('#inputBar'),
            $searchResult = $('#searchResult'),
            $searchText = $('#searchText'),
            $searchInput = $('#searchInput'),
            $searchClear = $('#searchClear'),
            $sendMessage = $('#sendMessage');

        function hideSearchResult(){
            $searchResult.hide();
            $searchInput.val('');
        }
        function cancelSearch(){
            hideSearchResult();
            $searchBar.removeClass('weui-search-bar_focusing');
            $searchText.show();
        }

        $searchText.on('click', function(){
            $searchBar.addClass('weui-search-bar_focusing');
            $searchInput.focus();
        });
        $searchInput
            .on('blur', function () {
                if(!this.value.length) cancelSearch();
            })
            .on('input', function(){
                if(this.value.length) {
                    $searchResult.show();
                } else {
                    $searchResult.hide();
                }
            })
        ;
        $searchClear.on('click', function(){
            hideSearchResult();
            $searchInput.focus();
        });
        $sendMessage.on('click', function(){
            cancelSearch();
            $searchInput.blur();
        });
    });
</script>

         
    </body>
</html>
